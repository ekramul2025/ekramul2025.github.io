<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Authenticator Web App</title>
<style>
:root{
  --bg:#0b1220; --card:#071427; --muted:#9aa4b2; --accent:#06b6d4; --danger:#ff5c5c;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,#00121a,#071429);
  color:#e6eef6;
  display:flex;
  justify-content:center;
  padding:28px;
}
.app{width:980px; max-width:98%;}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
h1{margin:0;font-size:20px;}
.controls{display:flex;gap:8px;align-items:center;}
button.btn{
  background:transparent;
  border:1px solid rgba(255,255,255,0.06);
  padding:8px 12px;
  border-radius:10px;
  color:var(--muted);
  cursor:pointer;
}
.primary{background:linear-gradient(90deg,var(--accent),#0ea5a1); color:#001;border:none;}
.list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  padding:14px;
  border-radius:12px;
  display:flex;
  gap:12px;
  align-items:center;
}
.left{width:72px;height:72px;display:grid;place-items:center;position:relative;}
svg{transform:rotate(-90deg);width:68px;height:68px;}
.otpBlock{flex:1;min-width:0;}
.issuer{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.account{font-size:13px;color:var(--muted);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.digits{font-family:ui-monospace,Menlo,monospace;font-size:26px;letter-spacing:6px;margin-top:6px;}
.metaRow{display:flex;align-items:center;gap:8px;margin-top:8px;}
.small{font-size:12px;color:var(--muted);}
.iconBtn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px;border-radius:8px;color:var(--muted);cursor:pointer;font-size:13px;}
.danger{border-color:rgba(255,92,92,0.15);color:var(--danger);}
.modalBg{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:grid;place-items:center;z-index:60;}
.modal{width:520px;max-width:96%;background:var(--card);padding:16px;border-radius:12px;}
label{display:block;font-size:13px;color:var(--muted);margin-top:10px;}
input[type="text"], input[type="number"], input[type="password"]{
  width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);
  background:transparent;color:inherit;font-family:monospace;
}
.empty{background:rgba(255,255,255,0.02);padding:20px;border-radius:10px;text-align:center;color:var(--muted);}
#qr-reader{width:100%; max-width:480px; margin:10px auto;}


</style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Authenticator</h1>
      <div class="controls">
        <button id="importBtn" class="btn">Import</button>
        <button id="exportBtn" class="btn">Export</button>
        <button id="scanBtn" class="btn">Scan QR</button>
        <button id="addBtn" class="btn primary">+ Add Account</button>
      </div>
    </header>
    <main>
      <div id="listArea" class="list"></div>
      <div id="empty" class="empty">কোনো অ্যাকাউন্ট নেই — Add Account চাপুন বা QR scan করুন।</div>
    </main>
  </div>

  <div id="modalRoot" style="display:none"></div>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script>

const LS_KEY = "totp_accounts_v1";

/* ===== BASE32 / TOTP FUNCTIONS ===== */
function base32ToBytes(base32){
  const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
  let bits=0,value=0,output=[];
  base32 = String(base32||"").toUpperCase().replace(/=+$/,"").replace(/[^A-Z2-7]/g,"");
  for(let i=0;i<base32.length;i++){
    const val = alphabet.indexOf(base32[i]); if(val==-1) continue;
    value=(value<<5)|val; bits+=5;
    if(bits>=8){ bits-=8; output.push((value>>>bits)&0xFF);}
  }
  return new Uint8Array(output);
}
function counterToBytes(counter){
  const buf=new ArrayBuffer(8); const view=new DataView(buf);
  const hi=Math.floor(counter/0x100000000); const lo=counter>>>0;
  view.setUint32(0,hi); view.setUint32(4,lo);
  return new Uint8Array(buf);
}
function bytesToHex(b){ return Array.from(b).map(x=>x.toString(16).padStart(2,"0")).join(""); }
async function hmacSha1(keyBytes,dataBytes){
  const cryptoKey=await crypto.subtle.importKey("raw",keyBytes,{name:"HMAC",hash:{name:"SHA-1"}},false,["sign"]);
  const sig = await crypto.subtle.sign("HMAC",cryptoKey,dataBytes);
  return new Uint8Array(sig);
}
function truncateToTOTP(hmacBytes,digits=6){
  const offset = hmacBytes[hmacBytes.length-1]&0x0f;
  const p = ((hmacBytes[offset]&0x7f)<<24)|((hmacBytes[offset+1]&0xff)<<16)|((hmacBytes[offset+2]&0xff)<<8)|(hmacBytes[offset+3]&0xff);
  return (p%Math.pow(10,digits)).toString().padStart(digits,"0");
}
async function totpForSecret(base32Secret,step=30,digits=6,atTime=null){
  const keyBytes = base32ToBytes(base32Secret);
  const unix = atTime!==null?Math.floor(atTime/1000):Math.floor(Date.now()/1000);
  const counter = Math.floor(unix/step);
  const counterBytes = counterToBytes(counter);
  const hmac = await hmacSha1(keyBytes,counterBytes);
  const otp = truncateToTOTP(hmac,digits);
  return {otp,hmacHex:bytesToHex(hmac),unix,counter};
}

/* ===== STORAGE ===== */
function loadAccounts(){ try{ const r = localStorage.getItem(LS_KEY); return r?JSON.parse(r):[]; }catch(e){return[];} }
function saveAccounts(a){ localStorage.setItem(LS_KEY,JSON.stringify(a)); }

/* ===== HEX <-> BASE32 ===== */
function isHex(s){ return /^[0-9a-fA-F]+$/.test(s); }
function hexToBytes(hex){
  const bytes=new Uint8Array(Math.ceil(hex.length/2));
  for(let i=0;i<bytes.length;i++) bytes[i]=parseInt(hex.substr(i*2,2),16);
  return bytes;
}
function bytesToBase32(bytes){
  const alphabet="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
  let bits=0,value=0,output="";
  for(let i=0;i<bytes.length;i++){
    value=(value<<8)|bytes[i]; bits+=8;
    while(bits>=5){ output+=alphabet[(value>>>(bits-5))&31]; bits-=5; }
  }
  if(bits>0) output+=alphabet[(value<<(5-bits))&31];
  return output;
}
function convertToBase32(secret){
  if(!secret) return "";
  if(isHex(secret)) return bytesToBase32(hexToBytes(secret));
  return secret.toUpperCase().replace(/[^A-Z2-7]/g,"");
}

/* ===== UI RENDER ===== */
const listArea=document.getElementById("listArea");
const empty=document.getElementById("empty");

function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8);}
function escapeHtml(s){return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

async function renderList(){
  const accounts=loadAccounts();
  listArea.innerHTML="";
  if(!accounts.length){ empty.style.display="block"; return;} else empty.style.display="none";
  for(const acc of accounts){
    const card=document.createElement("div"); card.className="card"; card.dataset.id=acc.id;
    card.innerHTML=`
      <div class="left">
        <svg viewBox="0 0 100 100" aria-hidden="true">
          <circle cx="50" cy="50" r="44" stroke="rgba(255,255,255,0.06)" stroke-width="12" fill="none"></circle>
          <circle class="prog" cx="50" cy="50" r="44" stroke="${acc.color||'#06b6d4'}" stroke-width="12" stroke-linecap="round" fill="none" stroke-dasharray="276.460" stroke-dashoffset="276.460"></circle>
        </svg>
        <div style="position:absolute;inset:0;display:grid;place-items:center;font-size:12px" class="secTxt">--</div>
      </div>
      <div class="otpBlock">
        <div class="issuer">${escapeHtml(acc.issuer||'App')}</div>
        <div class="account">${escapeHtml(acc.account||'account')}</div>
        <div class="digits">------</div>
        <div class="metaRow">
          <div class="small">Step: ${acc.step||30}s • Digits: ${acc.digits||6}</div>
          <div style="flex:1"></div>
          <button class="iconBtn copyBtn">Copy</button>
          <button class="iconBtn editBtn">Edit</button>
          <button class="iconBtn danger delBtn">Del</button>
        </div>
      </div>
    `;
    listArea.appendChild(card);
    attachDynamic(card,acc);
  }
}

/* ===== DYNAMIC CARD UPDATE ===== */
const cardAnim = new Map();
function attachDynamic(card,acc){
  const prog=card.querySelector(".prog");
  const secTxt=card.querySelector(".secTxt");
  const digitsEl=card.querySelector(".digits");
  const copyBtn=card.querySelector(".copyBtn");
  const editBtn=card.querySelector(".editBtn");
  const delBtn=card.querySelector(".delBtn");
  let raf=null;
  async function tick(){
    const step=acc.step||30;
    const unix=Math.floor(Date.now()/1000);
    const rem=step-(unix%step);
    const frac=rem/step;
    const circ=2*Math.PI*44;
    const offset=circ*(1-frac);
    prog.setAttribute("stroke-dashoffset",offset.toFixed(3));
    secTxt.textContent=rem+"s";
    try{
      const {otp}=await totpForSecret(convertToBase32(acc.secret),acc.step||30,acc.digits||6);
      digitsEl.textContent=otp;
    }catch(e){ digitsEl.textContent="err";}
    raf=requestAnimationFrame(tick);
  }
  if(cardAnim.has(card)) cancelAnimationFrame(cardAnim.get(card));
  cardAnim.set(card,requestAnimationFrame(tick));
  copyBtn.addEventListener("click",async ()=>{
    try{await navigator.clipboard.writeText(digitsEl.textContent||""); copyBtn.textContent="Copied"; setTimeout(()=>copyBtn.textContent="Copy",900);}catch(e){copyBtn.textContent="Err"; setTimeout(()=>copyBtn.textContent="Copy",900);}
  });
  delBtn.addEventListener("click",()=>{
    if(!confirm(`Delete ${acc.issuer} — ${acc.account}?`)) return;
    const arr=loadAccounts().filter(a=>a.id!==acc.id); saveAccounts(arr); renderList();
  });
}

renderList();


</script>
</body>
</html>