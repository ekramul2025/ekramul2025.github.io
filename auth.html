<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOTP Authenticator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* Dark theme with gradient background */
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to bottom, #1e1e1e, #333);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
        }

        .header button:hover {
            background: #45a049;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .card {
            background: #2c2c2c;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .card-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .card-account {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .otp {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            cursor: pointer;
        }

        .progress-ring {
            position: relative;
            width: 60px;
            height: 60px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 5;
            r: 25;
            cx: 30;
            cy: 30;
            stroke: #ddd;
        }

        .progress-ring .progress {
            stroke: #4CAF50;
            stroke-dasharray: 157;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.5s linear;
        }

        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
        }

        .buttons {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        .buttons button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }

        .buttons button:hover {
            background: #1E88E5;
        }

        .buttons .delete {
            background: #f44336;
        }

        .buttons .delete:hover {
            background: #d32f2f;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }

        .modal-content input, .modal-content select {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #555;
            background: #444;
            color: #fff;
            border-radius: 5px;
        }

        .modal-content button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }

        .modal-content button:hover {
            background: #45a049;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        #qr-reader {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }

        .error {
            color: #f44336;
            margin-top: 10px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TOTP Authenticator</h1>
            <div>
                <button onclick="openModal('add')">Add Account</button>
                <button onclick="openQRScanner()">Scan QR</button>
                <button onclick="openModal('import')">Import</button>
                <button onclick="openModal('export')">Export</button>
            </div>
        </div>
        <div class="grid" id="accounts-grid"></div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('add')">&times;</span>
            <h2 id="modal-title">Add Account</h2>
            <form id="account-form">
                <input type="text" id="issuer" placeholder="Issuer" required>
                <input type="text" id="account" placeholder="Account Name" required>
                <input type="text" id="secret" placeholder="Secret (Base32, Hex, or Plain Text)" required>
                <select id="digits">
                    <option value="6">6 Digits</option>
                    <option value="7">7 Digits</option>
                    <option value="8">8 Digits</option>
                </select>
                <input type="number" id="step" placeholder="Step (seconds)" min="10" max="300" value="30" required>
                <input type="color" id="color" placeholder="Color (optional)">
                <button type="button" onclick="saveAccount()">Save</button>
            </form>
            <div id="add-error" class="error"></div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('import')">&times;</span>
            <h2>Import Accounts</h2>
            <input type="file" id="import-file" accept=".json">
            <input type="password" id="import-password" placeholder="Master Password" required>
            <button onclick="importAccounts()">Import</button>
            <div id="import-error" class="error"></div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('export')">&times;</span>
            <h2>Export Accounts</h2>
            <input type="password" id="export-password" placeholder="Master Password" required>
            <button onclick="exportAccounts()">Export</button>
            <div id="export-error" class="error"></div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeQRScanner()">&times;</span>
            <h2>Scan QR Code</h2>
            <div id="qr-reader"></div>
            <div id="qr-error" class="error"></div>
        </div>
    </div>

    <script>
        // Base32 decode function
        function base32Decode(s) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            const padding = '=';
            s = s.toUpperCase().replace(/[^A-Z2-7]/g, '');
            let len = s.length;
            let bits = 0;
            let value = 0;
            let index = 0;
            let result = new Uint8Array(Math.ceil(len * 5 / 8));
            for (let i = 0; i < len; i++) {
                value = (value << 5) | alphabet.indexOf(s[i]);
                bits += 5;
                if (bits >= 8) {
                    result[index++] = (value >>> (bits - 8)) & 255;
                    bits -= 8;
                }
            }
            return result;
        }

        // Base32 encode function
        function base32Encode(bytes) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = 0;
            let value = 0;
            let result = '';
            for (let byte of bytes) {
                value = (value << 8) + byte;
                bits += 8;
                while (bits >= 5) {
                    bits -= 5;
                    result += alphabet[(value >>> bits) & 31];
                }
            }
            if (bits > 0) {
                result += alphabet[(value << (5 - bits)) & 31];
            }
            // Add padding to make length a multiple of 8
            while (result.length % 8 !== 0) {
                result += '=';
            }
            return result;
        }

        // Validate Base32
        function isValidBase32(str) {
            if (!str || typeof str !== 'string') return false;
            const cleanStr = str.toUpperCase().replace(/=+$/, '');
            return /^[A-Z2-7]+$/.test(cleanStr) && cleanStr.length >= 2;
        }

        // Process secret (convert to Base32 if needed)
        function processSecret(input) {
            if (!input || typeof input !== 'string') {
                throw new Error('Invalid or missing secret');
            }

            const cleanInput = input.trim().toUpperCase().replace(/[^A-Z0-9=]/g, '');

            // Check if input is valid Base32
            if (isValidBase32(cleanInput)) {
                try {
                    base32Decode(cleanInput); // Validate decoding
                    return cleanInput;
                } catch {
                    throw new Error('Invalid Base32 secret');
                }
            }

            // Try parsing as hex
            if (/^[0-9A-F]+$/i.test(cleanInput)) {
                try {
                    const bytes = new Uint8Array(cleanInput.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                    return base32Encode(bytes);
                } catch {
                    throw new Error('Invalid hex secret');
                }
            }

            // Treat as plain text and convert to Base32
            try {
                const encoder = new TextEncoder();
                const bytes = encoder.encode(input.trim());
                return base32Encode(bytes);
            } catch {
                throw new Error('Failed to convert secret to Base32');
            }
        }

        // HMAC-SHA1 using Web Crypto API
        async function hmacSha1(key, data) {
            const cryptoKey = await crypto.subtle.importKey(
                'raw', key, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']
            );
            return await crypto.subtle.sign('HMAC', cryptoKey, data);
        }

        // TOTP calculation
        async function generateTOTP(secretBase32, digits = 6, step = 30) {
            try {
                const secret = base32Decode(secretBase32);
                const time = Math.floor(Date.now() / 1000 / step);
                const timeBytes = new Uint8Array(8);
                for (let i = 7; i >= 0; i--) {
                    timeBytes[i] = time & 0xff;
                    time >>>= 8;
                }
                const hmac = await hmacSha1(secret, timeBytes);
                const hmacArray = new Uint8Array(hmac);
                const offset = hmacArray[19] & 0xf;
                let code = ((hmacArray[offset] & 0x7f) << 24) |
                           ((hmacArray[offset + 1] & 0xff) << 16) |
                           ((hmacArray[offset + 2] & 0xff) << 8) |
                           (hmacArray[offset + 3] & 0xff);
                code = code % (10 ** digits);
                return code.toString().padStart(digits, '0');
            } catch (e) {
                console.error('Error generating TOTP:', e.message);
                return 'ERROR';
            }
        }

        // Get remaining seconds in step
        function getRemainingSeconds(step) {
            return step - (Math.floor(Date.now() / 1000) % step);
        }

        // Accounts array
        let accounts = [];
        let editingIndex = -1;
        let scanner;

        // Load accounts from localStorage
        function loadAccounts() {
            const stored = localStorage.getItem('totp_accounts_v1');
            if (stored) {
                accounts = JSON.parse(stored);
            }
            if (accounts.length === 0) {
                // Add demo account
                accounts.push({
                    issuer: 'Demo',
                    account: 'demo@example.com',
                    secret: 'JBSWY3DPEHPK3PXP',
                    digits: 6,
                    step: 30,
                    color: getRandomColor()
                });
                saveAccounts();
            }
            renderAccounts();
        }

        // Save accounts to localStorage
        function saveAccounts() {
            localStorage.setItem('totp_accounts_v1', JSON.stringify(accounts));
        }

        // Render accounts
        function renderAccounts() {
            const grid = document.getElementById('accounts-grid');
            grid.innerHTML = '';
            accounts.forEach((acc, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                if (acc.color) card.style.borderLeft = `5px solid ${acc.color}`;

                const header = document.createElement('div');
                header.className = 'card-header';
                header.textContent = acc.issuer;

                const accountName = document.createElement('div');
                accountName.className = 'card-account';
                accountName.textContent = acc.account;

                const otp = document.createElement('div');
                otp.className = 'otp';
                otp.onclick = () => copyToClipboard(otp.textContent, otp);

                const progressRing = document.createElement('div');
                progressRing.className = 'progress-ring';
                progressRing.innerHTML = `
                    <svg width="60" height="60">
                        <circle r="25" cx="30" cy="30"></circle>
                        <circle class="progress" r="25" cx="30" cy="30"></circle>
                    </svg>
                    <div class="countdown"></div>
                `;

                const buttons = document.createElement('div');
                buttons.className = 'buttons';
                buttons.innerHTML = `
                    <button onclick="copyToClipboard(document.querySelectorAll('.otp')[${index}].textContent, this)">Copy</button>
                    <button onclick="editAccount(${index})">Edit</button>
                    <button class="delete" onclick="deleteAccount(${index})">Delete</button>
                `;

                // Show hex and Base32
                const details = document.createElement('div');
                details.style.fontSize = '12px';
                details.style.marginTop = '10px';
                try {
                    const secretBytes = base32Decode(acc.secret);
                    const hex = Array.from(secretBytes).map(b => b.toString(16).padStart(2, '0')).join('');
                    details.textContent = `Base32: ${acc.secret} | Hex: ${hex}`;
                } catch {
                    details.textContent = `Invalid Secret`;
                }

                card.appendChild(header);
                card.appendChild(accountName);
                card.appendChild(otp);
                card.appendChild(progressRing);
                card.appendChild(buttons);
                card.appendChild(details);
                grid.appendChild(card);
            });
            updateOTPs();
        }

        // Update OTPs every second
        setInterval(updateOTPs, 1000);

        async function updateOTPs() {
            const otps = document.querySelectorAll('.otp');
            const countdowns = document.querySelectorAll('.countdown');
            const progresses = document.querySelectorAll('.progress');
            for (let i = 0; i < accounts.length; i++) {
                const acc = accounts[i];
                try {
                    const otp = await generateTOTP(acc.secret, acc.digits, acc.step);
                    otps[i].textContent = otp;
                    const remaining = getRemainingSeconds(acc.step);
                    countdowns[i].textContent = remaining;
                    const progress = (remaining / acc.step) * 157; // 2 * PI * r â‰ˆ 157
                    progresses[i].style.strokeDashoffset = 157 - progress;
                } catch {
                    otps[i].textContent = 'ERROR';
                    countdowns[i].textContent = '-';
                    progresses[i].style.strokeDashoffset = 157;
                }
            }
        }

        // Open modal
        function openModal(type) {
            if (type === 'add') {
                document.getElementById('add-modal').style.display = 'flex';
                document.getElementById('modal-title').textContent = editingIndex === -1 ? 'Add Account' : 'Edit Account';
                if (editingIndex !== -1) {
                    const acc = accounts[editingIndex];
                    document.getElementById('issuer').value = acc.issuer;
                    document.getElementById('account').value = acc.account;
                    document.getElementById('secret').value = acc.secret;
                    document.getElementById('digits').value = acc.digits;
                    document.getElementById('step').value = acc.step;
                    document.getElementById('color').value = acc.color || '#ffffff';
                } else {
                    resetForm();
                }
            } else if (type === 'import') {
                document.getElementById('import-modal').style.display = 'flex';
            } else if (type === 'export') {
                document.getElementById('export-modal').style.display = 'flex';
            }
        }

        // Close modal
        function closeModal(type) {
            if (type === 'add') {
                document.getElementById('add-modal').style.display = 'none';
                resetForm();
                editingIndex = -1;
            } else if (type === 'import') {
                document.getElementById('import-modal').style.display = 'none';
            } else if (type === 'export') {
                document.getElementById('export-modal').style.display = 'none';
            }
            clearErrors();
        }

        function resetForm() {
            document.getElementById('issuer').value = '';
            document.getElementById('account').value = '';
            document.getElementById('secret').value = '';
            document.getElementById('digits').value = 6;
            document.getElementById('step').value = 30;
            document.getElementById('color').value = '#ffffff';
        }

        // Save account
        function saveAccount() {
            const issuer = document.getElementById('issuer').value.trim();
            const account = document.getElementById('account').value.trim();
            const secretInput = document.getElementById('secret').value.trim();
            const digits = parseInt(document.getElementById('digits').value);
            const step = parseInt(document.getElementById('step').value);
            const color = document.getElementById('color').value;

            if (!issuer || !account || !secretInput || isNaN(digits) || isNaN(step) || step < 10 || step > 300) {
                showError('add', 'Please fill all required fields correctly.');
                return;
            }

            let secret;
            try {
                secret = processSecret(secretInput);
            } catch (e) {
                showError('add', e.message);
                return;
            }

            const newAcc = { issuer, account, secret, digits, step, color: color !== '#ffffff' ? color : getRandomColor() };

            if (editingIndex === -1) {
                accounts.push(newAcc);
            } else {
                accounts[editingIndex] = newAcc;
                editingIndex = -1;
            }

            saveAccounts();
            renderAccounts();
            closeModal('add');
        }

        // Edit account
        function editAccount(index) {
            editingIndex = index;
            openModal('add');
        }

        // Delete account
        function deleteAccount(index) {
            if (confirm('Are you sure you want to delete this account?')) {
                accounts.splice(index, 1);
                saveAccounts();
                renderAccounts();
            }
        }

        // Copy to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button ? button.textContent : '';
                if (button) button.textContent = 'Copied!';
                setTimeout(() => {
                    if (button) button.textContent = originalText || 'Copy';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Get random color
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Open QR Scanner
        function openQRScanner() {
            document.getElementById('qr-modal').style.display = 'flex';
            const qrReader = document.getElementById('qr-reader');
            scanner = new Html5QrcodeScanner('qr-reader', { fps: 10, qrbox: 250 });
            scanner.render(onScanSuccess, onScanError);
        }

        // Close QR Scanner
        function closeQRScanner() {
            document.getElementById('qr-modal').style.display = 'none';
            if (scanner) {
                scanner.clear();
                scanner = null;
            }
            clearErrors();
        }

        // On QR scan success
        function onScanSuccess(decodedText) {
            try {
                let acc;
                if (decodedText.startsWith('otpauth://totp/')) {
                    const url = new URL(decodedText);
                    const label = url.pathname.substring(1).split(':');
                    const issuer = label[0];
                    const account = label[1] || '';
                    const params = url.searchParams;
                    const secret = processSecret(params.get('secret') || '');
                    acc = {
                        issuer: params.get('issuer') || issuer,
                        account: account || params.get('account'),
                        secret,
                        digits: parseInt(params.get('digits') || '6'),
                        step: parseInt(params.get('period') || '30'),
                        color: getRandomColor()
                    };
                } else {
                    acc = JSON.parse(decodedText);
                    acc.secret = processSecret(acc.secret);
                    acc.color = getRandomColor();
                }
                if (!acc.secret) throw new Error('Missing secret');
                accounts.push(acc);
                saveAccounts();
                renderAccounts();
                closeQRScanner();
            } catch (e) {
                showError('qr', 'Invalid QR code: ' + e.message);
            }
        }

        // On QR scan error
        function onScanError(error) {
            console.warn('QR error:', error);
        }

        // Encryption key derivation
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw', encoder.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']
            );
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        // Encrypt data
        async function encryptData(data, password) {
            const encoder = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const key = await deriveKey(password, salt);
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv },
                key,
                encoder.encode(JSON.stringify(data))
            );
            const encryptedArray = new Uint8Array(encrypted);
            return { salt, iv, encrypted: encryptedArray };
        }

        // Decrypt data
        async function decryptData(encryptedObj, password) {
            const { salt, iv, encrypted } = encryptedObj;
            const key = await deriveKey(password, salt);
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv },
                key,
                encrypted
            );
            const decoder = new TextDecoder();
            return JSON.parse(decoder.decode(decrypted));
        }

        // Export accounts
        async function exportAccounts() {
            const password = document.getElementById('export-password').value;
            if (!password) {
                showError('export', 'Password required.');
                return;
            }
            try {
                const encrypted = await encryptData(accounts, password);
                const json = JSON.stringify(encrypted);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'totp_accounts.json';
                a.click();
                URL.revokeObjectURL(url);
                closeModal('export');
            } catch (e) {
                showError('export', 'Export failed: ' + e.message);
            }
        }

        // Import accounts
        function importAccounts() {
            const file = document.getElementById('import-file').files[0];
            const password = document.getElementById('import-password').value;
            if (!file || !password) {
                showError('import', 'File and password required.');
                return;
            }
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const encryptedObj = JSON.parse(e.target.result);
                    // Convert arrays to Uint8Array if necessary
                    encryptedObj.salt = new Uint8Array(Object.values(encryptedObj.salt));
                    encryptedObj.iv = new Uint8Array(Object.values(encryptedObj.iv));
                    encryptedObj.encrypted = new Uint8Array(Object.values(encryptedObj.encrypted));
                    const imported = await decryptData(encryptedObj, password);
                    // Process secrets in imported accounts
                    imported.forEach(acc => {
                        acc.secret = processSecret(acc.secret);
                    });
                    accounts = imported;
                    saveAccounts();
                    renderAccounts();
                    closeModal('import');
                } catch (e) {
                    showError('import', 'Import failed: Invalid password or file.');
                }
            };
            reader.readAsText(file);
        }

        // Show error
        function showError(modal, message) {
            document.getElementById(`${modal}-error`).textContent = message;
        }

        // Clear errors
        function clearErrors() {
            document.querySelectorAll('.error').forEach(el => el.textContent = '');
        }

        // Initial load
        loadAccounts();
    </script>
</body>
</html>