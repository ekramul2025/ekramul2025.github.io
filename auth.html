<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TOTP Authenticator (Web)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- QR Code Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
/* ==== Global Styles ==== */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  color: #f0f0f0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
header {
  padding: 10px;
  text-align: center;
  background: rgba(0,0,0,0.3);
  font-size: 1.2em;
  font-weight: bold;
}
#accounts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px;
  padding: 12px;
  flex: 1;
}
.card {
  background: rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 16px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
}
.card h3 {
  margin: 0;
}
.card .otp {
  font-size: 1.8em;
  letter-spacing: 2px;
  margin: 10px 0;
}
.card .issuer {
  font-size: 0.9em;
  opacity: 0.8;
}
.card .countdown {
  font-size: 0.8em;
  opacity: 0.7;
}
.card button {
  margin-right: 6px;
}
.progress-ring {
  position: absolute;
  top: 8px; right: 8px;
  width: 40px; height: 40px;
}
footer {
  padding: 10px;
  text-align: center;
  background: rgba(0,0,0,0.3);
}
button, input, select {
  background: #222;
  color: #fff;
  border: 1px solid #555;
  border-radius: 6px;
  padding: 6px 10px;
}
button:hover {
  background: #444;
  cursor: pointer;
}
/* ==== Modal ==== */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: #1e1e1e;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
}
.modal-content h2 {
  margin-top: 0;
}
.modal-content label {
  display: block;
  margin-top: 10px;
}
.modal-content input {
  width: 100%;
}
.modal-content .actions {
  margin-top: 15px;
  text-align: right;
}
</style>
</head>
<body>
<header>
  üîê Web TOTP Authenticator
</header>

<div id="accounts"></div>

<footer>
  <button onclick="openAddModal()">‚ûï Add</button>
  <button onclick="startQrScan()">üì∑ Scan QR</button>
  <button onclick="exportAccounts()">‚¨áÔ∏è Export</button>
  <button onclick="importAccounts()">‚¨ÜÔ∏è Import</button>
</footer>

<!-- Add/Edit Modal -->
<div id="accountModal" class="modal">
  <div class="modal-content">
    <h2 id="modalTitle">Add Account</h2>
    <label>Issuer <input id="issuerInput"></label>
    <label>Account <input id="accountInput"></label>
    <label>Secret (Base32) <input id="secretInput"></label>
    <label>Digits <input id="digitsInput" type="number" value="6" min="6" max="8"></label>
    <label>Period (sec) <input id="stepInput" type="number" value="30" min="10" max="300"></label>
    <div class="actions">
      <button onclick="saveAccount()">Save</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- QR Scanner -->
<div id="qrModal" class="modal">
  <div class="modal-content" style="width:350px">
    <h2>Scan QR</h2>
    <div id="qrReader" style="width:300px"></div>
    <div class="actions"><button onclick="stopQrScan()">Close</button></div>
  </div>
</div>

<script>
/* ==== Utility Functions ==== */
function base32Decode(str) {
  const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
  let bits = '';
  let bytes = [];
  str = str.replace(/=+$/, '').toUpperCase();
  for (let i=0; i<str.length; i++) {
    let val = alphabet.indexOf(str[i]);
    if (val < 0) continue;
    bits += val.toString(2).padStart(5, '0');
  }
  for (let i=0; i+8<=bits.length; i+=8) {
    bytes.push(parseInt(bits.substring(i, i+8), 2));
  }
  return new Uint8Array(bytes);
}
async function hmacSha1(key, msg) {
  const cryptoKey = await crypto.subtle.importKey("raw", key, {name:"HMAC", hash:"SHA-1"}, false, ["sign"]);
  const sig = await crypto.subtle.sign("HMAC", cryptoKey, msg);
  return new Uint8Array(sig);
}
async function generateTOTP(secret, digits=6, step=30) {
  const key = base32Decode(secret);
  const counter = Math.floor(Date.now()/1000 / step);
  const msg = new ArrayBuffer(8);
  const view = new DataView(msg);
  view.setUint32(4, counter);
  const hmac = await hmacSha1(key, msg);
  const offset = hmac[hmac.length-1] & 0xf;
  const code = ((hmac[offset] & 0x7f)<<24 |
               (hmac[offset+1]<<16) |
               (hmac[offset+2]<<8) |
               (hmac[offset+3])) % (10**digits);
  return code.toString().padStart(digits,'0');
}

/* ==== State ==== */
let accounts = JSON.parse(localStorage.getItem("totp_accounts_v1")||"[]");
let editingIndex = null;

/* ==== Rendering ==== */
function renderAccounts() {
  const container = document.getElementById("accounts");
  container.innerHTML = '';
  if (accounts.length===0) {
    container.innerHTML = '<p style="text-align:center;opacity:0.7">No accounts yet.</p>';
    return;
  }
  accounts.forEach((acc,i)=>{
    const card = document.createElement("div");
    card.className="card";
    card.style.borderTop=`4px solid ${acc.color||"#0af"}`;
    card.innerHTML=`
      <h3>${acc.account}</h3>
      <div class="issuer">${acc.issuer||""}</div>
      <div class="otp" id="otp-${i}">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>
      <div class="countdown"><span id="cd-${i}"></span>s left</div>
      <button onclick="copyOtp(${i})">Copy</button>
      <button onclick="editAccount(${i})">Edit</button>
      <button onclick="deleteAccount(${i})">Delete</button>
      <svg class="progress-ring" viewBox="0 0 36 36">
        <path stroke="${acc.color||"#0af"}" stroke-width="4" fill="transparent"
          stroke-dasharray="100,100" stroke-linecap="round"
          d="M18 2.0845
             a 15.9155 15.9155 0 0 1 0 31.831
             a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <path id="ring-${i}" stroke="#555" stroke-width="4" fill="transparent"
          stroke-dasharray="0,100" stroke-linecap="round"
          d="M18 2.0845
             a 15.9155 15.9155 0 0 1 0 31.831
             a 15.9155 15.9155 0 0 1 0 -31.831"/>
      </svg>
    `;
    container.appendChild(card);
  });
}
async function updateOtps() {
  for (let i=0; i<accounts.length; i++) {
    try {
      const otp = await generateTOTP(accounts[i].secret, accounts[i].digits, accounts[i].step);
      document.getElementById(`otp-${i}`).innerText=otp;
      const now = Math.floor(Date.now()/1000);
      const remain = accounts[i].step - (now % accounts[i].step);
      document.getElementById(`cd-${i}`).innerText=remain;
      const percent = (remain/accounts[i].step)*100;
      document.getElementById(`ring-${i}`).setAttribute("stroke-dasharray", `${100-percent},100`);
    } catch(e) { }
  }
}
setInterval(updateOtps, 1000);

/* ==== Account Modal ==== */
function openAddModal() {
  editingIndex = null;
  document.getElementById("modalTitle").innerText="Add Account";
  document.getElementById("issuerInput").value="";
  document.getElementById("accountInput").value="";
  document.getElementById("secretInput").value="";
  document.getElementById("digitsInput").value=6;
  document.getElementById("stepInput").value=30;
  document.getElementById("accountModal").style.display="flex";
}
function closeModal() {
  document.getElementById("accountModal").style.display="none";
}
function saveAccount() {
  const acc = {
    issuer: document.getElementById("issuerInput").value.trim(),
    account: document.getElementById("accountInput").value.trim(),
    secret: document.getElementById("secretInput").value.trim(),
    digits: parseInt(document.getElementById("digitsInput").value)||6,
    step: parseInt(document.getElementById("stepInput").value)||30,
    color: `hsl(${Math.random()*360},70%,50%)`
  };
  if (!acc.secret) { alert("Secret required"); return; }
  if (editingIndex!==null) accounts[editingIndex]=acc;
  else accounts.push(acc);
  localStorage.setItem("totp_accounts_v1", JSON.stringify(accounts));
  closeModal();
  renderAccounts();
}
function editAccount(i) {
  editingIndex=i;
  const acc=accounts[i];
  document.getElementById("modalTitle").innerText="Edit Account";
  document.getElementById("issuerInput").value=acc.issuer;
  document.getElementById("accountInput").value=acc.account;
  document.getElementById("secretInput").value=acc.secret;
  document.getElementById("digitsInput").value=acc.digits;
  document.getElementById("stepInput").value=acc.step;
  document.getElementById("accountModal").style.display="flex";
}
function deleteAccount(i) {
  if(confirm("Delete this account?")) {
    accounts.splice(i,1);
    localStorage.setItem("totp_accounts_v1", JSON.stringify(accounts));
    renderAccounts();
  }
}

/* ==== Copy OTP ==== */
function copyOtp(i) {
  const otp=document.getElementById(`otp-${i}`).innerText;
  navigator.clipboard.writeText(otp);
  alert("Copied!");
}

/* ==== QR Scanner ==== */
let qrScanner=null;
function startQrScan() {
  document.getElementById("qrModal").style.display="flex";
  qrScanner = new Html5Qrcode("qrReader");
  qrScanner.start({facingMode:"environment"}, {fps:10, qrbox:250}, qr=> {
    handleQrResult(qr);
    stopQrScan();
  });
}
function stopQrScan() {
  if(qrScanner) { qrScanner.stop().then(()=>qrScanner.clear()); }
  document.getElementById("qrModal").style.display="none";
}
function handleQrResult(data) {
  try {
    if (data.startsWith("otpauth://")) {
      const url=new URL(data);
      const params=url.searchParams;
      const secret=params.get("secret");
      const issuer=params.get("issuer")||url.hostname;
      const account=decodeURIComponent(url.pathname).slice(1);
      accounts.push({issuer, account, secret, digits:6, step:30, color:`hsl(${Math.random()*360},70%,50%)`});
    } else {
      const obj=JSON.parse(data);
      accounts.push({issuer:obj.issuer, account:obj.account, secret:obj.secret, digits:obj.digits||6, step:obj.step||30, color:`hsl(${Math.random()*360},70%,50%)`});
    }
    localStorage.setItem("totp_accounts_v1", JSON.stringify(accounts));
    renderAccounts();
  } catch(e){ alert("Invalid QR"); }
}

/* ==== Import/Export ==== */
async function deriveKey(password,salt) {
  const keyMaterial = await crypto.subtle.importKey("raw", new TextEncoder().encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
  return crypto.subtle.deriveKey({name:"PBKDF2", salt:salt, iterations:100000, hash:"SHA-256"}, keyMaterial, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]);
}
async function exportAccounts() {
  const password=prompt("Enter password for export:");
  if(!password) return;
  const data=JSON.stringify(accounts);
  const salt=crypto.getRandomValues(new Uint8Array(16));
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const key=await deriveKey(password,salt);
  const enc=await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, new TextEncoder().encode(data));
  const blob=new Blob([salt,iv,new Uint8Array(enc)], {type:"application/octet-stream"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="totp_accounts.enc";
  a.click();
}
async function importAccounts() {
  const fileInput=document.createElement("input");
  fileInput.type="file";
  fileInput.onchange=async()=>{
    const file=fileInput.files[0];
    if(!file) return;
    const password=prompt("Enter password to import:");
    const buf=await file.arrayBuffer();
    const salt=new Uint8Array(buf.slice(0,16));
    const iv=new Uint8Array(buf.slice(16,28));
    const data=new Uint8Array(buf.slice(28));
    try {
      const key=await deriveKey(password,salt);
      const dec=await crypto.subtle.decrypt({name:"AES-GCM",iv}, key, data);
      const txt=new TextDecoder().decode(dec);
      accounts=JSON.parse(txt);
      localStorage.setItem("totp_accounts_v1", JSON.stringify(accounts));
      renderAccounts();
    } catch(e) {
      alert("Wrong password or corrupt file");
    }
  };
  fileInput.click();
}

/* ==== Init ==== */
if (accounts.length===0) {
  accounts.push({issuer:"Demo", account:"demo@example.com", secret:"JBSWY3DPEHPK3PXP", digits:6, step:30, color:"#0af"});
}
renderAccounts();
updateOtps();
</script>
</body>
</html>